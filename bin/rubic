#!/usr/bin/env ruby

require 'rubic'
require 'rubic/inspector'
require 'readline'

using Rubic::Inspector

if ARGV.size == 1
  file = ARGV.shift
  File.open(file) do |f|
    rubic = Rubic::Interpreter.new

    begin
      rubic.evaluate(f.read)
    rescue Rubic::RubicError => e
      puts "\e[31mError: #{e.message}\e[0m"
      exit false
    end
  end
else
  # REPL mode

  puts "Welcome to interactive Rubic (v#{Rubic::VERSION})"
  puts 'Hit ^D to exit'

  rubic = Rubic::Interpreter.new

  while input = Readline.readline(">> ", true)
    next if input.empty?
    while input.count('(') > input.count(')')
      input << Readline.readline(' | ', true)
    end

    begin
      puts '=> ' + rubic.evaluate(input).inspect
    rescue Rubic::RubicError => e
      puts "\e[31mError: #{e.message}\e[0m"
    end
  end
end
